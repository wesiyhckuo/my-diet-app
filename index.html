<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æˆ‘çš„ AI ç‡Ÿé¤Šå¸«</title>
    <style>
        body { font-family: -apple-system, sans-serif; background: #f4f4f9; display: flex; flex-direction: column; align-items: center; padding: 20px; }
        .card { background: white; padding: 20px; border-radius: 15px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); width: 100%; max-width: 400px; text-align: center; }
        h1 { color: #333; margin-bottom: 5px; font-size: 24px; }
        .total-kcal { font-size: 48px; color: #e67e22; font-weight: bold; margin: 10px 0; }
        .btn { background: #4a90e2; color: white; padding: 12px 24px; border-radius: 8px; border: none; cursor: pointer; font-size: 16px; margin: 10px 0; width: 100%; }
        #preview { width: 100%; border-radius: 10px; margin-top: 15px; display: none; }
        .history { width: 100%; max-width: 400px; margin-top: 20px; }
        .history-item { background: white; padding: 10px; border-radius: 8px; margin-bottom: 5px; display: flex; justify-content: space-between; font-size: 14px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        #loading { display: none; color: #666; margin: 10px 0; }
        input, select { padding: 10px; border: 1px solid #ddd; border-radius: 5px; margin: 5px; font-size: 14px; }
        details { text-align: left; margin-bottom: 20px; font-size: 14px; color: #666; width: 100%; }
    </style>
</head>
<body>

    <div class="card">
        <details>
            <summary>âš™ï¸ è¨­å®šå€‹äººåŸºæœ¬ä»£è¬ (BMR)</summary>
            <div style="background: #f9f9f9; padding: 10px; border-radius: 8px; margin-top: 10px; display: flex; flex-wrap: wrap; justify-content: center;">
                <select id="gender" style="width: 90%;">
                    <option value="male">æˆ‘æ˜¯ç”·ç”Ÿ</option>
                    <option value="female">æˆ‘æ˜¯å¥³ç”Ÿ</option>
                </select>
                <input type="number" id="userAge" placeholder="å¹´é½¡" style="width: 40%;">
                <input type="number" id="userHeight" placeholder="èº«é«˜(cm)" style="width: 40%;">
                <input type="number" id="userWeight" placeholder="é«”é‡(kg)" style="width: 40%;">
                <button class="btn" style="background: #34495e; padding: 8px; font-size: 14px;" onclick="calculateBMR()">æ›´æ–°æ¯æ—¥ç›®æ¨™</button>
            </div>
        </details>

        <h1>ä»Šæ—¥æ”å–ç†±é‡</h1>
        <div class="total-kcal" id="totalDisplay">0</div>
        <p>æ¯æ—¥ç›®æ¨™ï¼š<span id="targetDisplay">1400</span> kcal</p>

        <input type="file" id="fileInput" accept="image/*" capture="environment" style="display:none" onchange="previewAndAnalyze(event)">
        <button class="btn" onclick="document.getElementById('fileInput').click()">ğŸ“¸ æ‹æ”é£Ÿç‰©è¾¨è­˜</button>
        
        <div id="loading">ğŸ¤– AI æ­£åœ¨åˆ†æé£Ÿç‰©...</div>
        <img id="preview">

        <input type="number" id="calorieInput" placeholder="è¾¨è­˜çµæœæœƒé¡¯ç¤ºåœ¨æ­¤" style="width: 80%; text-align: center;">
        <button class="btn" style="background:#27ae60" onclick="addRecord()">â• è¨˜éŒ„é€™é¤ç†±é‡</button>
        <button class="btn" style="background:#95a5a6; font-size:12px; padding: 5px;" onclick="clearAll()">é‡è¨­ä»Šæ—¥ç´€éŒ„</button>
    </div>

    <div class="history" id="historyList"></div>

    <script>
        // è«‹ç¢ºä¿é€™è£¡å¡«å…¥ä½ æˆåŠŸçš„ API KEY
        const GEMINI_API_KEY = "AIzaSyAOJLwWaUDysWncxsDmsaY3zA5ALAz1nHQ"; 

        let history = JSON.parse(localStorage.getItem('diet_history')) || [];

        window.onload = () => {
            const savedTarget = localStorage.getItem('user_target_kcal');
            if (savedTarget) {
                document.getElementById('targetDisplay').innerText = savedTarget;
            }
            updateUI();
        };

        function calculateBMR() {
            const gender = document.getElementById('gender').value;
            const age = parseFloat(document.getElementById('userAge').value);
            const height = parseFloat(document.getElementById('userHeight').value);
            const weight = parseFloat(document.getElementById('userWeight').value);

            if (!age || !height || !weight) return alert("è«‹å¡«å¯«å®Œæ•´çš„è³‡è¨Šå–”ï¼");

            let bmr = (gender === 'male') 
                ? (10 * weight) + (6.25 * height) - (5 * age) + 5
                : (10 * weight) + (6.25 * height) - (5 * age) - 161;

            const finalTarget = Math.ceil(bmr);
            document.getElementById('targetDisplay').innerText = finalTarget;
            localStorage.setItem('user_target_kcal', finalTarget);
            alert("ç›®æ¨™å·²æ›´æ–°ç‚ºï¼š" + finalTarget + " kcal");
        }

        async function previewAndAnalyze(event) {
            const file = event.target.files[0];
            if (!file) return;

            document.getElementById('preview').src = URL.createObjectURL(file);
            document.getElementById('preview').style.display = 'block';
            document.getElementById('loading').style.display = 'block';
            document.getElementById('calorieInput').value = "";

            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onloadend = async () => {
                const base64Data = reader.result.split(',')[1];
                try {
                    const listRes = await fetch(`https://generativelanguage.googleapis.com/v1beta/models?key=${GEMINI_API_KEY}`);
                    const listData = await listRes.json();
                    const model = listData.models.find(m => m.name.includes("flash") && m.supportedGenerationMethods.includes("generateContent"));

                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/${model.name}:generateContent?key=${GEMINI_API_KEY}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            contents: [{ parts: [{ text: "é€™æ˜¯ä¸€å¼µé£Ÿç‰©ç…§ç‰‡ï¼Œè«‹åªå›å‚³ç†±é‡æ•¸å­—ã€‚" }, { inline_data: { mime_type: "image/jpeg", data: base64Data } }] }]
                        })
                    });

                    const data = await response.json();
                    if (data.candidates) {
                        const num = data.candidates[0].content.parts[0].text.trim().replace(/[^0-9]/g, '');
                        document.getElementById('calorieInput').value = num;
                    }
                } catch (e) {
                    alert("è¾¨è­˜å¤±æ•—ï¼Œè«‹æ‰‹å‹•è¼¸å…¥");
                } finally {
                    document.getElementById('loading').style.display = 'none';
                }
            };
        }

        function addRecord() {
            const kcal = parseInt(document.getElementById('calorieInput').value);
            if (!kcal) return alert("è«‹è¼¸å…¥æ•¸å­—");
            const now = new Date();
            const timeStr = `${now.getHours()}:${now.getMinutes().toString().padStart(2, '0')}`;
            history.unshift({ time: timeStr, kcal: kcal });
            localStorage.setItem('diet_history', JSON.stringify(history));
            document.getElementById('calorieInput').value = "";
            document.getElementById('preview').style.display = "none";
            updateUI();
        }

        function updateUI() {
            const list = document.getElementById('historyList');
            list.innerHTML = "<h3>ä»Šæ—¥é¤é»ç´€éŒ„</h3>";
            let total = 0;
            history.forEach(item => {
                total += item.kcal;
                const div = document.createElement('div');
                div.className = 'history-item';
                div.innerHTML = `<span>ğŸ•’ ${item.time}</span> <span>${item.kcal} kcal</span>`;
                list.appendChild(div);
            });
            document.getElementById('totalDisplay').innerText = total;
        }

        function clearAll() {
            if(confirm("ç¢ºå®šè¦åˆªé™¤æ‰€æœ‰ç´€éŒ„å—ï¼Ÿ")) {
                history = [];
                localStorage.removeItem('diet_history');
                updateUI();
            }
        }
    </script>
</body>
</html>
