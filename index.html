<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æˆ‘çš„ AI ç‡Ÿé¤Šå¸«</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: #f4f4f9; display: flex; flex-direction: column; align-items: center; padding: 20px; }
        .card { background: white; padding: 20px; border-radius: 15px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); width: 100%; max-width: 400px; text-align: center; position: relative; }
        h1 { color: #333; margin-bottom: 5px; font-size: 24px; }
        .total-kcal { font-size: 48px; color: #e67e22; font-weight: bold; margin: 10px 0; }
        .progress-container { width: 100%; background-color: #eee; border-radius: 20px; margin: 15px 0; height: 15px; overflow: hidden; }
        .progress-bar { height: 100%; width: 0%; background: #27ae60; transition: width 0.5s ease, background-color 0.5s ease; }
        .btn { background: #4a90e2; color: white; padding: 12px 24px; border-radius: 8px; border: none; cursor: pointer; font-size: 16px; margin: 10px 0; width: 100%; font-weight: bold; }
        #preview { width: 100%; border-radius: 10px; margin-top: 15px; display: none; }
        .history { width: 100%; max-width: 400px; margin-top: 20px; }
        .history-item { background: white; padding: 12px; border-radius: 8px; margin-bottom: 8px; display: flex; justify-content: space-between; font-size: 14px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        #loading { display: none; color: #666; margin: 10px 0; }
        input, select { padding: 10px; border: 1px solid #ddd; border-radius: 5px; margin: 5px; font-size: 14px; }
        details { text-align: left; margin-bottom: 20px; font-size: 14px; color: #666; width: 100%; border-bottom: 1px solid #eee; padding-bottom: 10px; }
        
        /* Toast & Modal */
        #toast { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.85); color: white; padding: 12px 24px; border-radius: 25px; display: none; z-index: 4000; font-size: 14px; white-space: nowrap; }
        #confirmModal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: none; justify-content: center; align-items: center; z-index: 3000; }
        .modal-content { background: white; padding: 25px; border-radius: 15px; width: 80%; max-width: 300px; text-align: center; }
        .modal-btns { display: flex; justify-content: space-around; margin-top: 20px; }
        .m-btn { border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: bold; }
        .btn-cancel { background: #eee; color: #666; }
        .btn-confirm { background: #e74c3c; color: white; }
        .fade-out { animation: fadeOut 0.5s forwards; }
        @keyframes fadeOut { from { opacity: 1; } to { opacity: 0; } }
    </style>
</head>
<body>

    <div id="toast"></div>

    <div id="confirmModal">
        <div class="modal-content">
            <h3>ç¢ºå®šè¦æ¸…é™¤å—ï¼Ÿ</h3>
            <p style="color: #666; font-size: 14px;">é€™å°‡æœƒåˆªé™¤ä»Šå¤©æ‰€æœ‰çš„é¤é»ç´€éŒ„å–”ï¼</p>
            <div class="modal-btns">
                <button class="m-btn btn-cancel" onclick="closeModal()">å–æ¶ˆ</button>
                <button class="m-btn btn-confirm" onclick="confirmClear()">ç¢ºå®šæ¸…é™¤</button>
            </div>
        </div>
    </div>

    <div class="card">
        <details>
            <summary>âš™ï¸ è¨­å®šå€‹äººåŸºæœ¬ä»£è¬ (BMR)</summary>
            <div style="background: #f9f9f9; padding: 15px; border-radius: 8px; margin-top: 10px; display: flex; flex-wrap: wrap; justify-content: center;">
                <select id="gender" style="width: 90%;">
                    <option value="male">æˆ‘æ˜¯ç”·ç”Ÿ</option>
                    <option value="female">æˆ‘æ˜¯å¥³ç”Ÿ</option>
                </select>
                <input type="number" id="userAge" placeholder="å¹´é½¡" style="width: 40%;">
                <input type="number" id="userHeight" placeholder="èº«é«˜(cm)" style="width: 40%;">
                <input type="number" id="userWeight" placeholder="é«”é‡(kg)" style="width: 40%;">
                <button class="btn" style="background: #34495e; padding: 8px; font-size: 14px;" onclick="calculateBMR()">æ›´æ–°æ¯æ—¥ç›®æ¨™</button>
            </div>
        </details>

        <h1>ä»Šæ—¥æ”å–ç†±é‡</h1>
        <div class="total-kcal" id="totalDisplay">0</div>
        <div class="progress-container"><div id="progressBar" class="progress-bar"></div></div>
        <p>æ¯æ—¥ç›®æ¨™ï¼š<span id="targetDisplay">1400</span> kcal</p>

        <input type="file" id="fileInput" accept="image/*" capture="environment" style="display:none" onchange="previewAndAnalyze(event)">
        <button class="btn" onclick="document.getElementById('fileInput').click()">ğŸ“¸ æ‹æ”é£Ÿç‰©è¾¨è­˜</button>
        <div id="loading">ğŸ¤– AI æ­£åœ¨çœ‹ç…§ç‰‡...</div>
        <img id="preview">
        <input type="number" id="calorieInput" placeholder="æˆ–æ‰‹å‹•è¼¸å…¥ç†±é‡" style="width: 80%; text-align: center; margin-top: 15px;">
        <button class="btn" style="background:#27ae60" onclick="addRecord()">â• è¨˜éŒ„é€™é¤ç†±é‡</button>
        <button class="btn" style="background:none; color:#95a5a6; font-size:12px; border:1px solid #ddd;" onclick="clearAll()">æ¸…é™¤ä»Šæ—¥æ•¸æ“š</button>
    </div>

    <div class="history" id="historyList"></div>

    <script>
        const GEMINI_API_KEY = "AIzaSyAOJLwWaUDysWncxsDmsaY3zA5ALAz1nHQ"; 
        let history = JSON.parse(localStorage.getItem('diet_history')) || [];

        window.onload = () => {
            const savedTarget = localStorage.getItem('user_target_kcal');
            if (savedTarget) document.getElementById('targetDisplay').innerText = savedTarget;
            updateUI();
        };

        function showToast(message) {
            const toast = document.getElementById('toast');
            toast.innerText = message; toast.style.display = 'block'; toast.classList.remove('fade-out');
            setTimeout(() => { toast.classList.add('fade-out'); setTimeout(() => { toast.style.display = 'none'; }, 500); }, 2500);
        }

        function clearAll() { document.getElementById('confirmModal').style.display = 'flex'; }
        function closeModal() { document.getElementById('confirmModal').style.display = 'none'; }
        function confirmClear() {
            history = []; localStorage.removeItem('diet_history');
            updateUI(); closeModal(); showToast("ğŸ§¹ ç´€éŒ„å·²å…¨éƒ¨æ¸…é™¤");
        }

        function calculateBMR() {
            const g = document.getElementById('gender').value, a = parseFloat(document.getElementById('userAge').value),
                  h = parseFloat(document.getElementById('userHeight').value), w = parseFloat(document.getElementById('userWeight').value);
            if (!a || !h || !w) return showToast("âš ï¸ è«‹å¡«å¯«å®Œæ•´è³‡è¨Š");
            let bmr = (g === 'male') ? (10*w + 6.25*h - 5*a + 5) : (10*w + 6.25*h - 5*a - 161);
            const target = Math.ceil(bmr);
            document.getElementById('targetDisplay').innerText = target;
            localStorage.setItem('user_target_kcal', target);
            showToast("âœ… ç›®æ¨™å·²æ›´æ–°"); updateUI();
        }

        async function previewAndAnalyze(event) {
            const file = event.target.files[0]; if (!file) return;
            document.getElementById('preview').src = URL.createObjectURL(file);
            document.getElementById('preview').style.display = 'block';
            document.getElementById('loading').style.display = 'block';
            const reader = new FileReader(); reader.readAsDataURL(file);
            reader.onloadend = async () => {
                const base64 = reader.result.split(',')[1];
                try {
                    const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models?key=${GEMINI_API_KEY}`);
                    const d = await res.json();
                    const m = d.models.find(x => x.name.includes("flash") && x.supportedGenerationMethods.includes("generateContent"));
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/${m.name}:generateContent?key=${GEMINI_API_KEY}`, {
                        method: 'POST', headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ contents: [{ parts: [{ text: "é€™æ˜¯ä¸€å¼µé£Ÿç‰©ç…§ç‰‡ï¼Œè«‹åªå›å‚³ç†±é‡æ•¸å­—ã€‚" }, { inline_data: { mime_type: "image/jpeg", data: base64 } }] }] })
                    });
                    const result = await response.json();
                    if (result.candidates) {
                        document.getElementById('calorieInput').value = result.candidates[0].content.parts[0].text.trim().replace(/[^0-9]/g, '');
                        showToast("âœ¨ AI è¾¨è­˜å®Œæˆï¼");
                    }
                } catch (e) { showToast("âŒ è¾¨è­˜å¤±æ•—"); } finally { document.getElementById('loading').style.display = 'none'; }
            };
        }

        function addRecord() {
            const kcal = parseInt(document.getElementById('calorieInput').value);
            if (!kcal) return showToast("âš ï¸ è«‹è¼¸å…¥æ•¸å­—");
            const now = new Date();
            history.unshift({ time: `${now.getHours()}:${now.getMinutes().toString().padStart(2,'0')}`, kcal: kcal });
            localStorage.setItem('diet_history', JSON.stringify(history));
            showToast("ğŸ› å·²è¨˜éŒ„ï¼š" + kcal + " kcal");
            document.getElementById('calorieInput').value = ""; document.getElementById('preview').style.display = "none";
            updateUI();
        }

        function updateUI() {
            const list = document.getElementById('historyList'), target = parseInt(document.getElementById('targetDisplay').innerText) || 1400;
            list.innerHTML = "<h3>ä»Šæ—¥é¤é»ç´€éŒ„</h3>";
            let total = 0;
            history.forEach(item => {
                total += item.kcal;
                const div = document.createElement('div'); div.className = 'history-item';
                div.innerHTML = `<span>ğŸ•’ ${item.time}</span> <span>${item.kcal} kcal</span>`;
                list.appendChild(div);
            });
            document.getElementById('totalDisplay').innerText = total;
            const bar = document.getElementById('progressBar'), per = (total / target) * 100;
            bar.style.width = Math.min(per, 100) + "%";
            bar.style.backgroundColor = per < 80 ? "#27ae60" : (per < 100 ? "#f1c40f" : "#e74c3c");
        }
    </script>
</body>
</html>
