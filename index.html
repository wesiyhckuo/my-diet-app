<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æˆ‘çš„ AI ç‡Ÿé¤Šå¸«</title>
    <style>
        body { font-family: -apple-system, sans-serif; background: #f4f4f9; display: flex; flex-direction: column; align-items: center; padding: 20px; }
        .card { background: white; padding: 20px; border-radius: 15px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); width: 100%; max-width: 400px; text-align: center; }
        h1 { color: #333; margin-bottom: 5px; }
        .total-kcal { font-size: 48px; color: #e67e22; font-weight: bold; margin: 10px 0; }
        .btn { background: #4a90e2; color: white; padding: 12px 24px; border-radius: 8px; border: none; cursor: pointer; font-size: 16px; margin: 10px 0; width: 100%; }
        #preview { width: 100%; border-radius: 10px; margin-top: 15px; display: none; }
        .history { width: 100%; max-width: 400px; margin-top: 20px; }
        .history-item { background: white; padding: 10px; border-radius: 8px; margin-bottom: 5px; display: flex; justify-content: space-between; font-size: 14px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        #loading { display: none; color: #666; margin: 10px 0; }
        input { padding: 10px; width: 80%; border: 1px solid #ddd; border-radius: 5px; margin: 10px 0; font-size: 16px; text-align: center; }
    </style>
</head>
<body>

    <div class="card">
        <h1>ä»Šæ—¥æ”å–ç†±é‡</h1>
        <div class="total-kcal" id="totalDisplay">0</div>
        <p>æ¯æ—¥ç›®æ¨™ï¼š1400 kcal</p>

        <input type="file" id="fileInput" accept="image/*" capture="environment" style="display:none" onchange="previewAndAnalyze(event)">
        <button class="btn" onclick="document.getElementById('fileInput').click()">ğŸ“¸ æ‹æ”é£Ÿç‰©è¾¨è­˜</button>
        
        <div id="loading">ğŸ¤– AI æ­£åœ¨åˆ†æé£Ÿç‰©...</div>
        <img id="preview">

        <input type="number" id="calorieInput" placeholder="è¾¨è­˜çµæœæœƒé¡¯ç¤ºåœ¨æ­¤">
        <button class="btn" style="background:#27ae60" onclick="addRecord()">â• è¨˜éŒ„é€™é¤ç†±é‡</button>
        <button class="btn" style="background:#95a5a6; font-size:12px" onclick="clearAll()">é‡è¨­ä»Šæ—¥ç´€éŒ„</button>
    </div>

    <div class="history" id="historyList">
        </div>

    <script>
        // 1. è«‹ç¢ºèªé€™è£¡å¡«å…¥ä½ é‚£æŠŠæˆåŠŸçš„ API KEY
        const GEMINI_API_KEY = "AIzaSyAOJLwWaUDysWncxsDmsaY3zA5ALAz1nHQ"; 
        let totalKcal = 0;
        let history = JSON.parse(localStorage.getItem('diet_history')) || [];

        // åˆå§‹åŒ–é é¢
        window.onload = () => {
            updateUI();
        };

        async function previewAndAnalyze(event) {
            const file = event.target.files[0];
            if (!file) return;

            const preview = document.getElementById('preview');
            preview.src = URL.createObjectURL(file);
            preview.style.display = 'block';
            document.getElementById('loading').style.display = 'block';
            document.getElementById('calorieInput').value = "";

            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onloadend = async () => {
                const base64Data = reader.result.split(',')[1];
                try {
                    // è‡ªå‹•æŠ“å–å¯ç”¨æ¨¡å‹åç¨± (ç¶­æŒä½ æœ€æˆåŠŸçš„é‚è¼¯)
                    const listRes = await fetch(`https://generativelanguage.googleapis.com/v1beta/models?key=${GEMINI_API_KEY}`);
                    const listData = await listRes.json();
                    const model = listData.models.find(m => m.name.includes("flash") && m.supportedGenerationMethods.includes("generateContent"));

                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/${model.name}:generateContent?key=${GEMINI_API_KEY}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            contents: [{
                                parts: [
                                    { text: "é€™æ˜¯ä¸€å¼µé£Ÿç‰©ç…§ç‰‡ï¼Œè«‹åªå›å‚³ä¼°è¨ˆç†±é‡æ•¸å­—ï¼ˆå¤§å¡ï¼‰ã€‚" },
                                    { inline_data: { mime_type: "image/jpeg", data: base64Data } }
                                ]
                            }]
                        })
                    });

                    const data = await response.json();
                    if (data.candidates) {
                        const aiResult = data.candidates[0].content.parts[0].text.trim();
                        const num = aiResult.replace(/[^0-9]/g, '');
                        document.getElementById('calorieInput').value = num;
                        // é€™è£¡ç§»é™¤äº† alertï¼Œæ”¹ç”¨éœ‡å‹•æé†’ï¼ˆéƒ¨åˆ†æ‰‹æ©Ÿæ”¯æ´ï¼‰
                        if (navigator.vibrate) navigator.vibrate(50);
                    }
                } catch (error) {
                    alert("è¾¨è­˜å¤±æ•—ï¼Œè«‹æ‰‹å‹•è¼¸å…¥æˆ–é‡è©¦");
                } finally {
                    document.getElementById('loading').style.display = 'none';
                }
            };
        }

        function addRecord() {
            const kcal = parseInt(document.getElementById('calorieInput').value);
            if (!kcal) return alert("è«‹è¼¸å…¥æ•¸å­—");

            const now = new Date();
            const timeStr = `${now.getHours()}:${now.getMinutes().toString().padStart(2, '0')}`;
            
            // åŠ å…¥æ­·å²é™£åˆ—
            history.unshift({ time: timeStr, kcal: kcal });
            localStorage.setItem('diet_history', JSON.stringify(history));
            
            document.getElementById('calorieInput').value = "";
            document.getElementById('preview').style.display = "none";
            updateUI();
        }

        function updateUI() {
            const list = document.getElementById('historyList');
            list.innerHTML = "<h3>ä»Šæ—¥é¤é»ç´€éŒ„</h3>";
            
            totalKcal = 0;
            history.forEach(item => {
                totalKcal += item.kcal;
                const div = document.createElement('div');
                div.className = 'history-item';
                div.innerHTML = `<span>ğŸ•’ ${item.time}</span> <span>${item.kcal} kcal</span>`;
                list.appendChild(div);
            });

            document.getElementById('totalDisplay').innerText = totalKcal;
        }

        function clearAll() {
            if(confirm("ç¢ºå®šè¦åˆªé™¤ä»Šå¤©çš„æ‰€æœ‰ç´€éŒ„å—ï¼Ÿ")) {
                history = [];
                localStorage.removeItem('diet_history');
                updateUI();
            }
        }
    </script>
</body>
</html>
